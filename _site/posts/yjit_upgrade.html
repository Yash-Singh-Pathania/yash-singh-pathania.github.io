

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>Moving From ruby 2.6 -&gt; Ruby 3.2 Yjit  - Hii There</title>







<meta property="og:locale" content="en-US">
<meta property="og:site_name" content="Hii There">
<meta property="og:title" content="Moving From ruby 2.6 -&gt; Ruby 3.2 Yjit">


  <link rel="canonical" href="http://localhost:4000/posts/yjit_upgrade">
  <meta property="og:url" content="http://localhost:4000/posts/yjit_upgrade">



  <meta property="og:description" content="As a developer at Tata 1mg, I recently led the upgrade of our Ruby on Rails app from Ruby 2.6 to Ruby 3.2. Our production setup was complex, with dual branches for C-Ruby and JRuby. This migration not only unified the Ruby versions across our services but also paved the way for containerization using Kubernetes (K8s), streamlining our deployment processes. In this post, I’ll walk you through the small syntax changes, breaking issues, and the peculiar adjustments I had to make for a smooth transition.">





  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2024-04-07T00:00:00+01:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Yash Singh Pathania",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Hii There Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    

<!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="57x57" href="http://localhost:4000/images/apple-touch-icon-57x57.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="60x60" href="http://localhost:4000/images/apple-touch-icon-60x60.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="76x76" href="http://localhost:4000/images/apple-touch-icon-76x76.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="120x120" href="http://localhost:4000/images/apple-touch-icon-120x120.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="152x152" href="http://localhost:4000/images/apple-touch-icon-152x152.png?v=M44lzPylqQ">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/images/apple-touch-icon-180x180.png?v=M44lzPylqQ">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32">
<link rel="icon" type="image/png" href="http://localhost:4000/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16">
<link rel="manifest" href="http://localhost:4000/images/manifest.json?v=M44lzPylqQ">
<link rel="mask-icon" href="http://localhost:4000/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000">
<link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ">
<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="http://localhost:4000/images/mstile-144x144.png?v=M44lzPylqQ">
<meta name="msapplication-config" content="http://localhost:4000/images/browserconfig.xml?v=M44lzPylqQ">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="http://localhost:4000/assets/css/academicons.css"/>


<!-- Support for MatJax -->
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://localhost:4000/">Hii There</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/publications/">Publications</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/year-archive/">Blog Posts</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/misc/">Misc</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    





<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="http://localhost:4000/images/profile.jpg" class="author__avatar" alt="Yash">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Yash</h3>
    <p class="author__pronouns">he/him</p>
    <p class="author__bio">Solving everyday problems through code, one line at a time.</p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      <!-- Font Awesome icons / Biographic information  -->
      
        <li class="author__desktop"><i class="fa-solid fa-location-dot icon-pad-right" aria-hidden="true"></i>Dublin, Ireland</li>
      

      
      
      
        <li><a href="mailto:yashpathania704@gmail.com"><i class="fas fa-fw fa-envelope icon-pad-right" aria-hidden="true"></i>Email</a></li>
      


  <li class="author__desktop" style="display: flex; align-items: center;">
    <i class="fa-solid fa-building-columns" aria-hidden="true"></i>
    <a href="https://www.ucd.ie" target="_blank" style="margin-left: 0.2em;">UCD</a>
  </li>


  <li class="author__desktop" style="display: flex; align-items: center;">
    <i class="fa-solid fa-book icon-pad-right" aria-hidden="true"></i>
    <a href="https://www.thapar.edu" target="_blank" style="margin-left: 0.02em;">TIET</a>
  </li>


      <!-- Font Awesome and Academicons icons / Academic websites -->
            
      
      
      
      
                              
      

      <!-- Font Awesome icons / Repositories and software development -->
      
            
            
      
        <li><a href="https://github.com/Yash-Singh-Pathania"><i class="fab fa-fw fa-github icon-pad-right" aria-hidden="true"></i>Github</a></li>
      
            
            

      <!-- Font Awesome icons / Social media -->
      
      

      
        <li><a href="https://monkeytype.com/profile/Yash_07"><i class="fa-solid fa-keyboard icon-pad-right" aria-hidden="true"></i>Monkeytype</a></li>
      
            
      
                  
                  
      
            
            
      
        <li><a href="https://www.linkedin.com/in/yashhere/"><i class="fab fa-fw fa-linkedin icon-pad-right" aria-hidden="true"></i>LinkedIn</a></li>
            
      
            
                  
            
      
            
            
      
              
      
                      
      
      
            
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    
      <meta itemprop="headline" content="Moving From ruby 2.6 -&gt; Ruby 3.2 Yjit">
    
    
      <meta itemprop="description" content="As a developer at Tata 1mg, I recently led the upgrade of our Ruby on Rails app from Ruby 2.6 to Ruby 3.2. Our production setup was complex, with dual branches for C-Ruby and JRuby. This migration not only unified the Ruby versions across our services but also paved the way for containerization using Kubernetes (K8s), streamlining our deployment processes. In this post, I’ll walk you through the small syntax changes, breaking issues, and the peculiar adjustments I had to make for a smooth transition.">
    
    
      <meta itemprop="datePublished" content="April 07, 2024">
    
    

    <div class="page__inner-wrap">
      
        <header>
          
            <h1 class="page__title" itemprop="headline">Moving From ruby 2.6 -&gt; Ruby 3.2 Yjit
</h1>
          
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  4 minute read
	
</p>
          
          
          
            <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Published:</strong> <time datetime="2024-04-07T00:00:00+01:00">April 07, 2024</time></p>
              
        </header>
      

      <section class="page__content" itemprop="text">
        <p>As a developer at Tata 1mg, I recently led the upgrade of our Ruby on Rails app from Ruby 2.6 to Ruby 3.2. Our production setup was complex, with dual branches for C-Ruby and JRuby. This migration not only unified the Ruby versions across our services but also paved the way for containerization using Kubernetes (K8s), streamlining our deployment processes. In this post, I’ll walk you through the small syntax changes, breaking issues, and the peculiar adjustments I had to make for a smooth transition.</p>

<h3 id="why-ruby-32">Why Ruby 3.2?</h3>

<p>Ruby 3.2 brings many exciting changes:</p>
<ul>
  <li><strong>YJIT</strong>: Faster execution with Just-in-Time compilation.</li>
  <li><strong>Ractor improvements</strong>: True parallel execution.</li>
  <li><strong>Memory efficiency</strong>: Improved garbage collection and memory management.</li>
  <li><strong>Better syntax</strong>: Cleaner and faster code execution.</li>
</ul>

<p>But along with these came breaking changes that impacted how we wrote and executed code. Below are the key challenges I faced and the solutions I implemented.</p>

<hr />

<h2 id="1-positional-vs-keyword-arguments">1. <strong>Positional vs. Keyword Arguments</strong></h2>

<p>Ruby 2.7 started the shift with deprecation warnings about positional vs. keyword arguments, and by Ruby 3.2, this became a hard error.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 2.6 - This works</span>
<span class="k">def</span> <span class="nf">method_a</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="nb">puts</span> <span class="n">options</span>
<span class="k">end</span>

<span class="n">method_a</span><span class="p">(</span><span class="ss">key: </span><span class="s1">'value'</span><span class="p">)</span>

<span class="c1"># Ruby 3.2 - This raises an ArgumentError</span>
<span class="n">method_a</span><span class="p">({</span> <span class="ss">key: </span><span class="s1">'value'</span> <span class="p">})</span>  <span class="c1"># Must explicitly pass as a hash</span>
</code></pre></div></div>

<p><strong>Fix</strong>: All methods that receive keyword arguments need to explicitly define them.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 3.2 - Fix</span>
<span class="k">def</span> <span class="nf">method_a</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="n">options</span>
<span class="k">end</span>

<span class="n">method_a</span><span class="p">(</span><span class="ss">key: </span><span class="s1">'value'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="2-endless-method-definitions">2. <strong>Endless Method Definitions</strong></h2>

<p>Ruby 3.0 introduced endless method definitions, improving readability for simple methods. We adopted this in some of our utility methods.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 2.6</span>
<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">end</span>

<span class="c1"># Ruby 3.2 - Endless method definition</span>
<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div></div>

<hr />

<h2 id="3-hash-default-values-and-frozen-strings">3. <strong>Hash Default Values and Frozen Strings</strong></h2>

<p>In Ruby 3.0, string literals are frozen by default, which can lead to errors if your code modifies strings or uses mutable defaults in hashes.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 2.6</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="nb">hash</span><span class="p">[</span><span class="ss">:key</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s1">'value'</span>   <span class="c1"># This works fine</span>

<span class="c1"># Ruby 3.2</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="nb">hash</span><span class="p">[</span><span class="ss">:key</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s1">'value'</span>   <span class="c1"># FrozenError: can't modify frozen String</span>
</code></pre></div></div>

<p><strong>Fix</strong>: Use a block to return a mutable default.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 3.2 - Fix</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span> <span class="p">}</span>
<span class="nb">hash</span><span class="p">[</span><span class="ss">:key</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s1">'value'</span>   <span class="c1"># Works fine</span>
</code></pre></div></div>

<hr />

<h2 id="4-pattern-matching-improvements">4. <strong>Pattern Matching Improvements</strong></h2>

<p>Ruby 3.x introduced expanded pattern matching, making it easier to work with complex data.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 3.2 - Pattern Matching Example</span>
<span class="k">case</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="k">in</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">]</span>
  <span class="nb">puts</span> <span class="s2">"a=</span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">, b=</span><span class="si">#{</span><span class="n">b</span><span class="si">}</span><span class="s2">, rest=</span><span class="si">#{</span><span class="n">rest</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
<span class="c1"># Outputs: a=1, b=2, rest=[3]</span>
</code></pre></div></div>

<hr />

<h2 id="5-deprecation-of-to_h-with-no-arguments">5. <strong>Deprecation of <code class="language-plaintext highlighter-rouge">#to_h</code> with No Arguments</strong></h2>

<p><code class="language-plaintext highlighter-rouge">#to_h</code> used to work without arguments in Ruby 2.6, but not anymore in Ruby 3.2.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 2.6</span>
<span class="n">my_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">key: </span><span class="s1">'value'</span> <span class="p">}</span>
<span class="n">my_hash</span><span class="p">.</span><span class="nf">to_h</span>    <span class="c1"># This works</span>

<span class="c1"># Ruby 3.2 - This throws an error</span>
<span class="n">my_hash</span><span class="p">.</span><span class="nf">to_h</span>    <span class="c1"># ArgumentError: wrong number of arguments (given 0, expected 1)</span>
</code></pre></div></div>

<p><strong>Fix</strong>: Provide arguments or handle the conversion explicitly.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 3.2 - Fix</span>
<span class="n">my_hash</span><span class="p">.</span><span class="nf">to_h</span> <span class="p">{</span> <span class="o">|</span><span class="n">pair</span><span class="o">|</span> <span class="n">pair</span> <span class="p">}</span>   <span class="c1"># Works fine</span>
</code></pre></div></div>

<hr />

<h2 id="6-ractor-and-thread-safety">6. <strong>Ractor and Thread Safety</strong></h2>

<p>One of the most exciting features of Ruby 3.x is <strong>Ractor</strong>, enabling parallel execution. However, global variables and shared state need to be refactored for thread safety.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ruby 2.6 - Global caching</span>
<span class="vg">$cache</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">cache_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="vg">$cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="k">end</span>

<span class="c1"># Ruby 3.2 - Ractor-safe refactor</span>
<span class="k">class</span> <span class="nc">Cache</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="vi">@lock</span> <span class="o">=</span> <span class="no">Mutex</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">cache_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="vi">@lock</span><span class="p">.</span><span class="nf">synchronize</span> <span class="p">{</span> <span class="vi">@cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="7-other-minor-gotchas">7. <strong>Other Minor Gotchas</strong></h2>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">Bignum</code> and <code class="language-plaintext highlighter-rouge">Fixnum</code> unified into <code class="language-plaintext highlighter-rouge">Integer</code></strong>: Ensure no legacy code depends on these.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">URI.encode</code> and <code class="language-plaintext highlighter-rouge">URI.decode</code></strong> are deprecated: Use <code class="language-plaintext highlighter-rouge">URI.encode_www_form</code> or <code class="language-plaintext highlighter-rouge">CGI.escape</code>.</li>
  <li><strong>Method visibility with blocks</strong>: Ruby 3.x changes how visibility modifiers (<code class="language-plaintext highlighter-rouge">public</code>, <code class="language-plaintext highlighter-rouge">protected</code>, <code class="language-plaintext highlighter-rouge">private</code>) interact with methods accepting blocks.</li>
</ul>

<hr />

<h2 id="the-benefits-of-the-migration">The Benefits of the Migration</h2>

<p>The upgrade to Ruby 3.2 not only gave us performance improvements (thanks to YJIT) but also allowed us to unify our C-Ruby and JRuby branches into a single Ruby version. This paved the way for transitioning our production app to Kubernetes (K8s), making deployments more streamlined and scalable.</p>

<p>With faster processing, reduced memory overhead, and the flexibility of containerized microservices, this migration allowed us to improve overall system efficiency while simplifying our infrastructure management.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Migrating from Ruby 2.6 to Ruby 3.2 in a production environment comes with its challenges, but the benefits far outweigh the effort. By addressing syntax changes, frozen string literals, and thread safety, we were able to optimize both performance and deployment. Ruby 3.2, paired with Kubernetes, made our production processes faster, more efficient, and easier to manage.</p>

<p>This migration has set the stage for future improvements in both code performance and infrastructure scalability, and I highly recommend other teams to make the switch.</p>

<p>Happy coding!</p>


        

        
      </section>

      <footer class="page__meta">
        
        


  




  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#engineering" class="page__taxonomy-item" rel="tag">engineering</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#ruby" class="page__taxonomy-item" rel="tag">ruby</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#yjit" class="page__taxonomy-item" rel="tag">yjit</a>
    
    </span>
  </p>




      </footer>
    </div>

    
  </article>

  
  

  
  
</div>

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
<a href="/sitemap/">Sitemap</a>
<!-- end custom footer snippets -->

        


<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="http://github.com/Yash-Singh-Pathania"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
  </ul>
</div>


<div class="page__footer-copyright">
  &copy; 2024 Yash Singh Pathania
</div>
      </footer>
    </div>

    <script src="http://localhost:4000/assets/js/main.min.js"></script>









  </body>
</html>

